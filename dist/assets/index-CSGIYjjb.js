import{r as $,o as E,a as L,c as x,p as C,b as w,d as g,F as b,e as y,f as O,w as F,g as u,h as v,i as k}from"./index-nTGwexDI.js";import{a as S}from"./axios-Cm0UX6qg.js";const U=(t,n)=>{const l=t.__vccOpts||t;for(const[o,_]of n)l[o]=_;return l},B=t=>t>=1024*1024*1024?(t/(1024*1024*1024)).toFixed(2)+"G":t>=1024*1024?(t/(1024*1024)).toFixed(2)+"M":t>=1024?(t/1024).toFixed(2)+"K":t+"B",A=t=>(C("data-v-254a7378"),t=t(),w(),t),P=A(()=>g("span",null,"拖拽文件到此处上传",-1)),G=[P],I={__name:"DragUpLoadFiles",emits:["getFilesList"],setup(t,{emit:n}){const l=n,o=$(null),_=async a=>{if(a.isDirectory){const i=a.createReader(),f=await new Promise((e,s)=>{i.readEntries(e,s)});let d=[];for(const e of f){const s=await _(e);d=d.concat(s)}return d}else return[await new Promise((f,d)=>{a.file(f,d)})]},p=async a=>{const i=[];for(const e of a){const s=e.webkitGetAsEntry();i.push(_(s))}const d=(await Promise.all(i)).flat();l("getFilesList",d)};return E(()=>{o.value.addEventListener("dragover",a=>{a.preventDefault(),o.value.style.opacity="0.5"}),o.value.addEventListener("dragleave",a=>{a.preventDefault(),o.value.style.opacity="1"}),o.value.addEventListener("drop",a=>{a.preventDefault(),o.value.style.opacity="1",p(a.dataTransfer.items)})}),(a,i)=>(L(),x("div",{class:"dragContainer",ref_key:"dragContainer",ref:o},G,512))}},R=U(I,[["__scopeId","data-v-254a7378"]]),T=t=>(C("data-v-32c40b8f"),t=t(),w(),t),V=T(()=>g("div",{style:{display:"flex"}},[g("label",{for:"uploadFiles",class:"uploadFiles"},[g("span",null,"上传文件")]),g("label",{for:"uploadFolder",class:"uploadFolder"},[g("span",null,"上传文件夹")])],-1)),q={__name:"UpLoadFiles",emits:["getFilesList"],setup(t,{emit:n}){const l=n,o=p=>{const a=p.target.files;l("getFilesList",a)},_=p=>{const a=p.target.files;l("getFilesList",a)};return(p,a)=>(L(),x(b,null,[V,g("input",{type:"file",id:"uploadFiles",multiple:"",onChange:o},null,32),g("input",{type:"file",id:"uploadFolder",webkitdirectory:"",mozdirectory:"",odirectory:"",onChange:_},null,32)],64))}},M=U(q,[["__scopeId","data-v-32c40b8f"]]),j={__name:"UpLoadList",props:{list:{type:Array,default:()=>[]}},emits:["pauseFileUpLoad","runOnFileUpLoad"],setup(t,{emit:n}){const l=n,o=p=>{l("pauseFileUpLoad",p)},_=p=>{l("runOnFileUpLoad",p)};return(p,a)=>{const i=y("a-table-column"),f=y("a-progress"),d=y("a-button"),e=y("a-table");return L(),O(e,{data:t.list,"show-empty-tree":"",style:{"margin-top":"20px","margin-bottom":"20px"},pagination:{pageSize:10}},{columns:F(()=>[u(i,{title:"序号","data-index":"key"}),u(i,{title:"文件名",ellipsis:!0,"data-index":"name"}),u(i,{title:"文件大小","data-index":"size"}),u(i,{title:"文件类型","data-index":"type"}),u(i,{title:"上传进度"},{cell:F(({record:s})=>[u(f,{type:"circle",size:"small",percent:s.progress},null,8,["percent"])]),_:1}),u(i,{title:"操作设置"},{cell:F(({record:s})=>[u(d,{type:"primary",status:"warning",size:"mini",onClick:c=>o(s.key)},{default:F(()=>[v("暂停上传")]),_:2},1032,["onClick"]),u(d,{type:"primary",status:"success",size:"mini",onClick:c=>_(s.key)},{default:F(()=>[v("继续上传")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])}}},D=S.create({baseURL:"http://localhost:3000"}),J=(t,n,l=o=>o)=>D({url:"/upload",method:"post",data:t,headers:{"Content-Type":"multipart/form-data"},signal:n,onUploadProgress:l}).catch(o=>{console.log("Request canceled",o.message)}),K=t=>D({url:"/merge",method:"post",data:JSON.stringify(t)}),W={__name:"index",setup(t){const n=k([]),l=k({}),o=e=>{const s=Array.from(e).filter(r=>r.name!==".DS_Store"),c=new AbortController;s.forEach(r=>{const m=_(r);l[n.length]=m;const h=r.name.split(".");n.push({key:n.length,name:h[0],type:h[h.length-1],size:B(r.size),progress:0,file:r,controller:c,signal:c.signal})})},_=(e,s=1*1024*1024)=>{const c=[];let r=0,m=0;for(;r<e.size;)c.push({file:e.slice(r,r+s),chunkName:`${e.name}-${m}`,fileName:e.name}),r+=s,m++;return c},p=()=>{for(const e in l)a(l[e]).forEach((c,r)=>{J(c,n[e].signal,i(l[e][r],e,l[e].length))})},a=e=>e.map(({file:s,fileName:c,chunkName:r})=>{const m=new FormData;return m.append("file",s),m.append("fileName",c),m.append("chunkName",r),m}),i=(e,s,c)=>r=>{const m=r.loaded/r.total,h=1/c;if(e.progress=Number(m.toFixed(2)),e.progress===1){let N=n[s].progress+h;n[s].progress=Number(N.toFixed(2)),l[s].find(z=>z.progress!==1)||(n[s].progress=1,K({fileName:n[s].file.name,size:1*1024*1024}))}},f=e=>{n[e].controller.abort()},d=e=>{};return(e,s)=>{const c=y("a-button");return L(),x(b,null,[u(R,{onGetFilesList:o}),u(M,{onGetFilesList:o}),u(j,{list:n,onPauseFileUpLoad:f,onRunOnFileUpLoad:d},null,8,["list"]),u(c,{type:"primary",status:"success",onClick:p},{default:F(()=>[v("开始上传")]),_:1})],64)}}};export{W as default};
